trigger:
  branches:
    include:
      - main

variables:
  buildConfiguration: Release
  dotNetSdkVersion: 10.x
  projectPath: src/InClassBff.Api/InClassBFF.Api.csproj
  azureServiceConnection: 'inclass-azure-service-collection'
  webAppName: 'inclass-bff'
  webAppKind: webApp
  healthCheckPath: /
  healthCheckProtocol: https
  healthCheckRetries: 12
  healthCheckDelaySeconds: 10
  healthCheckExpectedCodes: 200,204,301,302

stages:
- stage: Build
  displayName: Build and publish artifact
  jobs:
  - job: Build
    pool:
      vmImage: windows-latest
    steps:
    - task: UseDotNet@2
      displayName: Install .NET SDK $(dotNetSdkVersion)
      inputs:
        packageType: sdk
        version: $(dotNetSdkVersion)

    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: $(projectPath)

    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: build
        projects: $(projectPath)
        arguments: --configuration $(buildConfiguration) --no-restore

    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        publishWebProjects: false
        projects: $(projectPath)
        arguments: --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)
        zipAfterPublish: true

    - task: PublishBuildArtifacts@1
      displayName: Publish artifact
      inputs:
        PathtoPublish: $(Build.ArtifactStagingDirectory)
        ArtifactName: drop
        publishLocation: Container

- stage: Deploy
  displayName: Deploy to Azure Web App
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployWebApp
    displayName: Deploy
    environment: production
    pool:
      name: 'Default'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: Azure Web App Deploy
            inputs:
              azureSubscription: $(azureServiceConnection)
              appType: $(webAppKind)
              appName: $(webAppName)
              package: $(Pipeline.Workspace)/drop/**/*.zip

          - task: PowerShell@2
            displayName: Pipeline health check
            inputs:
              targetType: inline
              script: |
                $healthUrl = "$(healthCheckProtocol)://$(webAppName).azurewebsites.net$(healthCheckPath)"
                $retries = [int]"$(healthCheckRetries)"
                $delaySeconds = [int]"$(healthCheckDelaySeconds)"
                $expectedCodes = "$(healthCheckExpectedCodes)".Split(',') | ForEach-Object { [int]$_.Trim() }

                Write-Host "Health check URL: $healthUrl"
                Write-Host "Expected codes: $($expectedCodes -join ', ')"

                for ($attempt = 1; $attempt -le $retries; $attempt++) {
                  try {
                    $response = Invoke-WebRequest -Uri $healthUrl -Method GET -TimeoutSec 20 -MaximumRedirection 5
                    $statusCode = [int]$response.StatusCode
                    Write-Host "Attempt $attempt/$retries returned HTTP $statusCode"
                  } catch {
                    if ($_.Exception.Response) {
                      $statusCode = [int]$_.Exception.Response.StatusCode.value__
                      Write-Host "Attempt $attempt/$retries returned HTTP $statusCode"
                    } else {
                      $statusCode = -1
                      Write-Host "Attempt $attempt/$retries failed: $($_.Exception.Message)"
                    }
                  }

                  if ($expectedCodes -contains $statusCode) {
                    Write-Host "Health check passed."
                    exit 0
                  }

                  if ($attempt -lt $retries) {
                    Start-Sleep -Seconds $delaySeconds
                  }
                }

                throw "Health check failed after $retries attempts. URL: $healthUrl"
