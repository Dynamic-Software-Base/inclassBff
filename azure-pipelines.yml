trigger:
  branches:
    include:
      - main

# ─────────────────────────────────────────────
# Variable group: Pipelines → Library → inclass-bff-vars
# Required variables:
#   AZURE_SERVICE_CONNECTION, WEB_APP_NAME, WEB_APP_HOST_NAME,
#   KEYCLOAK_AUTHORITY, KEYCLOAK_CLIENT_ID, KEYCLOAK_CLIENT_SECRET,
#   API_ADDRESS, ALLOWED_CORS_ORIGINS
#
# ALLOWED_CORS_ORIGINS should now be the BFF App Service URL:
#   https://inclass-bff-bqg5g9d6caa9g4es.westeurope-01.azurewebsites.net
# (no longer the SWA URL — Angular is served from the BFF itself)
# ─────────────────────────────────────────────
variables:
  - group: inclass-bff-vars
  - name: buildConfiguration
    value: Release
  - name: dotNetSdkVersion
    value: 10.x
  - name: projectPath
    value: src/InClassBff.Api/InClassBFF.Api.csproj
  - name: webAppKind
    value: webApp
  - name: healthCheckPath
    value: /health
  - name: healthCheckProtocol
    value: https
  - name: healthCheckRetries
    value: 12
  - name: healthCheckDelaySeconds
    value: 10
  - name: healthCheckExpectedCodes
    value: '200,204,301,302'

stages:

  # ═══════════════════════════════════════════════════════
  # STAGE 1 – Build
  # ═══════════════════════════════════════════════════════
  - stage: Build
    displayName: Build and publish artifact
    jobs:
      - job: Build
        pool:
          name: 'Default'
        steps:

          # ── Debug: dump all env vars ─────────────────────────────────
          - task: PowerShell@2
            displayName: '[DEBUG] Print environment variables'
            inputs:
              targetType: inline
              script: |
                Write-Host "========================================"
                Write-Host "  ENVIRONMENT VARIABLES ON BUILD AGENT"
                Write-Host "========================================"
                Get-ChildItem Env: | Sort-Object Name | ForEach-Object {
                  Write-Host "$($_.Name) = $($_.Value)"
                }
                Write-Host ""
                Write-Host "========================================"
                Write-Host "  PIPELINE VARIABLES (resolved)"
                Write-Host "========================================"
                Write-Host "buildConfiguration    = $(buildConfiguration)"
                Write-Host "dotNetSdkVersion      = $(dotNetSdkVersion)"
                Write-Host "projectPath           = $(projectPath)"
                Write-Host "webAppName            = $(WEB_APP_NAME)"
                Write-Host "webAppHostName        = $(WEB_APP_HOST_NAME)"
                Write-Host "keycloakAuthority     = $(KEYCLOAK_AUTHORITY)"
                Write-Host "keycloakClientId      = $(KEYCLOAK_CLIENT_ID)"
                Write-Host "keycloakClientSecret  = ***  (secret - intentionally hidden)"
                Write-Host "apiAddress            = $(API_ADDRESS)"
                Write-Host "allowedCorsOrigins    = $(ALLOWED_CORS_ORIGINS)"

          - task: UseDotNet@2
            displayName: Install .NET SDK $(dotNetSdkVersion)
            inputs:
              packageType: sdk
              version: $(dotNetSdkVersion)

          - task: DotNetCoreCLI@2
            displayName: Restore
            inputs:
              command: restore
              projects: $(projectPath)

          - task: DotNetCoreCLI@2
            displayName: Build
            inputs:
              command: build
              projects: $(projectPath)
              arguments: --configuration $(buildConfiguration) --no-restore

          - task: DotNetCoreCLI@2
            displayName: Publish
            inputs:
              command: publish
              publishWebProjects: false
              projects: $(projectPath)
              arguments: --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)
              zipAfterPublish: true
            # Note: wwwroot/ is in the repo root. The .csproj will include it
            # automatically via the default Content glob. No extra config needed.

          - task: PublishBuildArtifacts@1
            displayName: Publish artifact
            inputs:
              PathtoPublish: $(Build.ArtifactStagingDirectory)
              ArtifactName: drop
              publishLocation: Container

  # ═══════════════════════════════════════════════════════
  # STAGE 2 – Deploy
  # ═══════════════════════════════════════════════════════
  - stage: Deploy
    displayName: Deploy to Azure Web App
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployWebApp
        displayName: Deploy
        environment: production
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:

                - task: PowerShell@2
                  displayName: '[DEBUG] Confirm deploy-stage variables'
                  inputs:
                    targetType: inline
                    script: |
                      Write-Host "========================================"
                      Write-Host "  DEPLOY STAGE – VARIABLE SPOT CHECK"
                      Write-Host "========================================"
                      Write-Host "azureServiceConnection = $(AZURE_SERVICE_CONNECTION)"
                      Write-Host "webAppName             = $(WEB_APP_NAME)"
                      Write-Host "webAppHostName         = $(WEB_APP_HOST_NAME)"
                      Write-Host "keycloakAuthority      = $(KEYCLOAK_AUTHORITY)"
                      Write-Host "keycloakClientId       = $(KEYCLOAK_CLIENT_ID)"
                      Write-Host "keycloakClientSecret   = ***  (secret)"
                      Write-Host "apiAddress             = $(API_ADDRESS)"
                      Write-Host "allowedCorsOrigins     = $(ALLOWED_CORS_ORIGINS)"
                      Write-Host "ASPNETCORE_ENVIRONMENT = Production"

                - task: AzureWebApp@1
                  displayName: Azure Web App Deploy
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    appType: $(webAppKind)
                    appName: $(WEB_APP_NAME)
                    package: $(Pipeline.Workspace)/drop/**/*.zip
                    appSettings: >-
                      -ASPNETCORE_ENVIRONMENT Production
                      -Keycloak__Authority $(KEYCLOAK_AUTHORITY)
                      -Keycloak__ClientId $(KEYCLOAK_CLIENT_ID)
                      -Keycloak__ClientSecret $(KEYCLOAK_CLIENT_SECRET)
                      -ReverseProxy__Clusters__api-cluster__Destinations__api-destination__Address $(API_ADDRESS)
                      -AllowedCorsOrigins $(ALLOWED_CORS_ORIGINS)

                - task: PowerShell@2
                  displayName: Pipeline health check
                  inputs:
                    targetType: inline
                    script: |
                      $hostName = "$(WEB_APP_HOST_NAME)"
                      if ([string]::IsNullOrWhiteSpace($hostName)) {
                        $hostName = "$(WEB_APP_NAME).azurewebsites.net"
                      }
                      $healthUrl = "$(healthCheckProtocol)://$hostName$(healthCheckPath)"
                      $retries = [int]"$(healthCheckRetries)"
                      $delaySeconds = [int]"$(healthCheckDelaySeconds)"
                      $expectedCodes = "$(healthCheckExpectedCodes)".Split(',') | ForEach-Object { [int]$_.Trim() }

                      Write-Host "Health check URL: $healthUrl"
                      Write-Host "Expected codes: $($expectedCodes -join ', ')"

                      for ($attempt = 1; $attempt -le $retries; $attempt++) {
                        try {
                          $response = Invoke-WebRequest -Uri $healthUrl -Method GET -TimeoutSec 20 -MaximumRedirection 5
                          $statusCode = [int]$response.StatusCode
                          Write-Host "Attempt $attempt/$retries returned HTTP $statusCode"
                        } catch {
                          if ($_.Exception.Response) {
                            $statusCode = [int]$_.Exception.Response.StatusCode.value__
                            Write-Host "Attempt $attempt/$retries returned HTTP $statusCode"
                          } else {
                            $statusCode = -1
                            Write-Host "Attempt $attempt/$retries failed: $($_.Exception.Message)"
                          }
                        }

                        if ($expectedCodes -contains $statusCode) {
                          Write-Host "Health check passed."
                          exit 0
                        }

                        if ($attempt -lt $retries) {
                          Start-Sleep -Seconds $delaySeconds
                        }
                      }

                      throw "Health check failed after $retries attempts. URL: $healthUrl"