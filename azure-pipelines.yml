trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  buildConfiguration: Release
  dotNetSdkVersion: 10.x
  projectPath: src/InClassBff.Api/InClassBFF.Api.csproj
  azureServiceConnection: YOUR-AZURE-SERVICE-CONNECTION
  webAppName: YOUR-AZURE-WEBAPP-NAME

stages:
- stage: Build
  displayName: Build and publish artifact
  jobs:
  - job: Build
    pool:
      vmImage: windows-latest
    steps:
    - task: UseDotNet@2
      displayName: Install .NET SDK $(dotNetSdkVersion)
      inputs:
        packageType: sdk
        version: $(dotNetSdkVersion)

    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: $(projectPath)

    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: build
        projects: $(projectPath)
        arguments: --configuration $(buildConfiguration) --no-restore

    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        publishWebProjects: false
        projects: $(projectPath)
        arguments: --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)
        zipAfterPublish: true

    - task: PublishBuildArtifacts@1
      displayName: Publish artifact
      inputs:
        PathtoPublish: $(Build.ArtifactStagingDirectory)
        ArtifactName: drop
        publishLocation: Container

- stage: Deploy
  displayName: Deploy to Azure Web App
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployWebApp
    displayName: Deploy
    environment: production
    pool:
      vmImage: windows-latest
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            displayName: Azure Web App Deploy
            inputs:
              azureSubscription: $(azureServiceConnection)
              appType: webApp
              appName: $(webAppName)
              package: $(Pipeline.Workspace)/drop/**/*.zip
